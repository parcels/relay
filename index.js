// Generated by CoffeeScript 1.7.1
(function() {
  var Q, app, dotenv, express, fetchRussianPost, fetchUSPS, http, port, respond, soap, wsdl, xml2js;

  dotenv = require('dotenv');

  dotenv.load();

  express = require('express');

  app = express();

  app.use(express.compress());

  soap = require('soap');

  Q = require('q');

  http = require('q-io/http');

  xml2js = require('xml2json');

  fetchRussianPost = function(client) {
    return function(trackId) {
      var message;
      message = {
        Barcode: trackId,
        MessageType: 0
      };
      return Q.nfcall(client.GetOperationHistory, message);
    };
  };

  fetchUSPS = function(trackId) {
    var url;
    url = "http://production.shippingapis.com/ShippingAPI.dll?API=TrackV2&XML= <TrackFieldRequest USERID=\"" + process.env.USPS_USER_ID + "\"> <TrackID ID=\"" + trackId + "\"></TrackID> </TrackFieldRequest>";
    return http.request(url).then(function(response) {
      return response.body.read();
    }).then(function(body) {
      return Q(xml2js.toJson(body, {
        object: true
      }));
    });
  };

  respond = function(fn) {
    return function(req, res) {
      return fn(req.params.trackId).then(function(result) {
        if (result) {
          return res.json(result);
        } else {
          return res.send(404);
        }
      })["catch"](function(err) {
        console.error(err);
        return res.json(500, {
          error: err
        });
      });
    };
  };

  wsdl = './lib/russianpost/wsdl/russianpost_1.wsdl';

  Q.nfcall(soap.createClient, wsdl).then(function(client) {
    app.get('/russianpost/:trackId', respond(fetchRussianPost(client)));
    return console.log('[INFO] RussianPost client established');
  })["catch"](function(err) {
    return console.error(err);
  }).done();

  app.get('/usps/:trackId', respond(fetchUSPS));

  console.log('[INFO] USPS client established');

  port = process.env.PORT || 3000;

  app.listen(port);

  console.log("[INFO] Listening on port " + port);

}).call(this);
